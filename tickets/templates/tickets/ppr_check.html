{% extends 'base.html' %}

{% block content %}



<div class="container">
	<div class="card mb-2">
            <h5 class="card-header">Параметры</h5>
          <div class="card-body">
              <div class="row">
                <div class="col-3">
                    <div class="form-group">
                        <input type="text" id="id_ppr" class="form-control" placeholder="ППР">
                    </div>
                </div>
              </div>
					<div class="row">
                        <div class="col-3">
                                <div class="form-group get_node">
                                    <button class="btn btn-info btn-block" id="id_get_node" type="button">
                                      <span class="" role="status" aria-hidden="true"></span>
                                        <span class="sr-only">Lo...</span>
                                        Проверить ППР
                                    </button>

                                </div>
                            </div>
                    </div>
			  		<div id="forms">
                    </div>
		  </div>
	</div>
</div>


<script>
$(function () {

	$('#id_get_node').click(function () {
          $(this).find('span').addClass('spinner-border spinner-border-sm');

          console.log(999)
          var ppr = Number($("#id_ppr").val().trim().replace("#",""))
          console.log(88)
          console.log(ppr)
          var url_mask = "{% url 'ppr_test_get_page_check' id_ppr=12345 %}".replace(/12345/, ppr.toString());
          // создаем AJAX-вызов
          $.ajax({

              url: url_mask,
              // если успешно, то
              success: function (response) {
                  $('#id_get_node').find('span').removeClass('spinner-border spinner-border-sm');
                  if (response.error) {
                      alert(response.error);
                  }

                  else {
                      //удаляем html если был предыдущий запрос
                      $("#forms").empty();
                      //$("#forms").html("");

                      //удаляем Event Listeners если был предыдущий запрос
                      $("div#forms").off();

                      console.log('form')
                      console.log($("#forms"))

                      var dict = response.result
                      var result = response.result

                      for (let [check_name, check_value] of Object.entries(dict)) {


                          if (check_name.includes("table_resource")) {
                            console.log(111)
                            var message = dict[check_name].messages;
                            var set = dict[check_name].set;
                            var row = 0


                            $("#forms").append(`

                            ${message}
                            <a class="but_${check_name} buk" id="button_${check_name}">(показать)</a></li></ul>


                            <table class="table table-striped" id="${check_name}">
                            <thead>
                                <tr>
                                    <th style="font-size:80%;">Номер договора</th>
                                    <th style="font-size:80%;">ФИО/Название</th>
                                    <th style="font-size:80%;">Тип</th>
                                    <th style="font-size:80%;">Ресурс</th>
                                    <th style="font-size:80%;">Бандл</th>
                                    <th style="font-size:80%;">Коммутатор</th>
                                    <th style="font-size:80%;">Порт</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                            </table>
                            `);
                            for (let row = 0; row < set.length; row++) {
                            $("#"+check_name).find('tbody').append(`
                            <tr>
                                <td style="font-size:80%;">${set[row][0]}</td>
                                <td style="font-size:80%;">${set[row][1]}</td>
                                <td style="font-size:80%;">${set[row][2]}</td>
                                <td style="font-size:80%;">${set[row][3]}</td>
                                <td style="font-size:80%;">${set[row][4]}</td>
                                <td style="font-size:80%;">${set[row][5]}</td>
                                <td style="font-size:80%;">${set[row][6]}</td>
                            </tr>
                              `);
                            }
                          }
                          else if (check_name.includes("table_device")) {
                            var message = dict[check_name].messages;
                            var set = dict[check_name].set;
                            var row = 0
                            $("#forms").append(`
                            ${message}
                            <a class="but_${check_name} buk" id="button_${check_name}"> (показать)</a></li></ul>
                            <table class="table table-striped" id="${check_name}">
                            <thead>
                                <tr>
                                    <th style="font-size:80%;">Коммутатор</th>
                                    <th style="font-size:80%;">Узел связи</th>
                                    <th style="font-size:80%;">Модель устройства</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                            </table>
                            `);
                            console.log($("#"+check_name).find('tbody'))
                            for (let row = 0; row < set.length; row++) {
                            $("#"+check_name).find('tbody').append(`
                                <tr>
                                    <td style="font-size:80%;">${set[row][0]}</td>
                                    <td style="font-size:80%;">${set[row][1]}</td>
                                    <td style="font-size:80%;">${set[row][2]}</td>
                                </tr>
                                  `);
                            }

                        }
                        else {
                            var message = dict[check_name].messages;
                            $("#forms").append(`
                            <p>${message}</p>

                            `);
                        }

                        $('#forms').on('click', '.but_'+check_name, function() {
                            if ($('#'+check_name).css('display') == 'none') {
                                $('#'+check_name).show();
                                $(this).text('(скрыть)');
                            }
                            else {
                                $('#'+check_name).hide();
                                $(this).text('(показать)');
                            }
                        });

                    }
					$('.table').css("display","none");
				}
              },
              error: function (response) {
                  $('#id_get_node').find('span').removeClass('spinner-border spinner-border-sm');
                  alert("Не удалось получить объекты ППР.");

              }
          });
          return false;
        });
});





</script>

{% endblock %}