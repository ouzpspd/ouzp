{% extends 'base.html' %}
{% block content %}

<html style="font-size:0.85rem">



<div class="container">
<div class="card mb-2">
    <h5 class="card-header">Анализ портов АМ, КПА</h5>
  <div class="card-body">
    <div class="container mb-4">
<div class="row">
  <div class="col-5">
    <div class="d-flex">
      <textarea class="form-control mt-3 mr-4" rows="10" id="text_rezerv" placeholder="Введите название АМ/КПА в столбик"></textarea>
      <div class="d-flex flex-column mt-3 col-6">
        <button class="btn btn-info mb-3 rez" id="add_rezerv">
            <span class="" role="status" aria-hidden="true"></span>
            <span class="sr-only">Lo...</span>
            Подписать Rezerv_1G_planning
        </button>
        <button class="btn btn-info mb-3 rez" id="remove_rezerv">
            <span class="" role="status" aria-hidden="true"></span>
            <span class="sr-only">Lo...</span>
            Снять Rezerv_1G_planning
        </button>
        <button class="btn btn-info mb-3 rez" id="show_rezerv">
            <span class="" role="status" aria-hidden="true"></span>
            <span class="sr-only">Lo...</span>
            Посчитать порты<br>1G / 10G
        </button>
        <button class="btn btn-info" id="excel">
            <span class="" role="status" aria-hidden="true"></span>
            <span class="sr-only">Lo...</span>
            Выгрузить результаты<br>в excel
        </button>

      </div>
    </div>
  </div>

    <div class="col-7">
        <div class="card mt-3" id="logs">
        <div class="card-body">
            <!-- Прогресс бар -->
            <div class="progress mb-3">
                <div id="progress-bar" class="progress-bar" role="progressbar"
                     style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    <span id="progress-text">0%</span>
                </div>
            </div>
            <!-- Сообщения -->
            <div id="messages" class="messages-container">
                <!-- Сообщения будут добавляться здесь-->
            </div>
        </div>
        </div>
    </div>

</div>
</div>


  </div>
</div>
</div>

<div class="container">
<table class="table table-striped table-bordered" id="table-rezerv">
      <thead>
        <tr>
          <th scope="col"></th>
            <th scope="col">Коммутатор</th>
          <th scope="col">Rezerv 1G</th>
            <th scope="col">Rezerv 1G planning</th>
          <th scope="col">Rezerv DIR.I2.4.4</th>
            <th scope="col">1G без деск</th>
            <th scope="col">10G без деск</th>
            <th scope="col">1G прочие резервы</th>
            <th scope="col">10G прочие резервы</th>
            <th scope="col">1G с деск без линка</th>
            <th scope="col">10G с деск без линка</th>
        </tr>
      </thead>
    <tbody id="rezerv">
    </tbody>
</table>
</div>


<style>
.dropdown-content {
    display: none;
}

.dropdown-btn {
    cursor: pointer;
    color: blue;
    text-decoration: underline;
}

.messages-container {
    height: 190px;
    overflow-y: auto;
    border: 1px solid #ddd;
    padding: 10px;
    background: #f8f9fa;
    scroll-behavior: smooth;
}

.messages-container::-webkit-scrollbar {
    width: 8px;
}

.messages-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.messages-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.messages-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

.message {
    padding: 8px;
    margin: 5px 0;
    border-radius: 4px;
}

.message.info { background: #d1ecf1; border-left: 4px solid #17a2b8; }
.message.success { background: #d4edda; border-left: 4px solid #28a745; }
.message.error { background: #f8d7da; border-left: 4px solid #dc3545; }
.message.warning { background: #ffeaa7; border-left: 4px solid #e67e22; }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
<script>

$(function () {
    $("#table-rezerv").hide();
    $("#logs").hide();
});

// раскрытие списков в таблице
function toggleDropdown(button) {

    const content = button.nextElementSibling;
    const cell = button.parentElement;
    const isHidden = content.style.display === 'none';
    document.querySelectorAll('.dropdown-content').forEach(content => {
    content.style.display = 'none';
    content.previousElementSibling.textContent = 'Показать';
    content.parentElement.style.minWidth = '';
    });

    if (isHidden) {
        content.style.display = 'block';
        button.textContent = 'Скрыть';

        let maxWidth = Array.from(content.children).reduce((max, item) => {
            return Math.max(max, item.textContent.length);
        }, 0);
        maxWidth = maxWidth < 50 ? maxWidth : 50;

        cell.style.minWidth = `${maxWidth}ch`;
    } else {
        content.style.display = 'none';
        button.textContent = 'Показать';
        cell.style.minWidth = '';
    }

}


// WebSocket соединение
const rezervSocket = new WebSocket(
    'ws://' + window.location.host +
    '/ws/rezerv-1g/'
);

const requiredReserve = {
    add: 'add',
    remove: 'remove',
    show: 'show'
};


// Обработка кнопок территорий
function handleClick(action) {
    if (requiredReserve[action] == 'add') {
        var answer = confirm('Вы действительно хотите зарезервировать порты на оборудовании?');
        if (!answer) {
            e.preventDefault();
            return false;
        }
    } else if (requiredReserve[action] == 'remove') {
        var answer = confirm('Вы действительно хотите снять резерв с портов на оборудовании?');
        if (!answer) {
            e.preventDefault();
            return false;
            }
    } else {
    }
    $("#table-rezerv").hide();
    $("#logs").show();
    $("#messages").empty();
    updateProgress(0);
    var switch_name = $("#text_rezerv").val().trim().replaceAll('\n', ';');

    if (rezervSocket.readyState === WebSocket.OPEN) {
        rezervSocket.send(JSON.stringify({
            'switches': switch_name,
            'action': action,
        }));
        $(`#${action}_rezerv`).find('span').addClass('spinner-border spinner-border-sm');
        $('.rez').prop('disabled', true);
    } else {
        alert('Ошибка. Сервер не отвечает. Попробуйте перезагрузить страницу.');
    }
}

// Обработчики для кнопок
$('#remove_rezerv').click(function() {
    handleClick('remove');
});

// Обработчики для кнопок
$('#add_rezerv').click(function() {
    handleClick('add');
});

// Обработчики для кнопок
$('#show_rezerv').click(function() {
    handleClick('show');
});


// Обработчик закрытия WebSocket
rezervSocket.onclose = function(e) {
    alert('Ошибка. Сбой на сервере. Попробуйте перезагрузить страницу.');
    $('.rez').find('span').removeClass('spinner-border spinner-border-sm');
    $('.rez').prop('disabled', false);
};


// получение данных таблицы
function getTable() {
    let data = [];
    let columns = [
        "Коммутатор", "Rezerv_1G", "Rezerv_1G_planning", "Rezerv_DIR.I2.4.4",
        "Количество 1G портов без дескрипшена", "Количество 10G портов без дескрипшена",
        "Количество 1G портов прочие резервы", "1G прочие резервы", "Количество 10G портов прочие резервы",
        "10G прочие резервы", "Количество 1G портов с дескрипшеном без линка", "1G с дескрипшеном без линка",
        "Количество 10G портов с дескрипшеном без линка", "10G с дескрипшеном без линка"
    ]
    data.push(columns)

    $('#rezerv tr').each(function() {
        let row = [];
        let cells = $(this).find('td');

        row.push($(cells[0]).text().trim());
        row.push(Number($(cells[1]).text().trim()));
        row.push(Number($(cells[2]).text().trim()));
        row.push(Number($(cells[3]).text().trim()));
        row.push(Number($(cells[4]).text().trim()));
        row.push(Number($(cells[5]).text().trim()));

        let cell_6 = $(cells[6]).text().trim().split('\n');
        row.push(Number(cell_6[0]));
        row.push(cell_6.slice(4).map((x) => x.trim()).filter(Boolean).join('\n'));

        let cell_7 = $(cells[7]).text().trim().split('\n');
        row.push(Number(cell_7[0]));
        row.push(cell_7.slice(4).map((x) => x.trim()).filter(Boolean).join('\n'));

        let cell_8 = $(cells[8]).text().trim().split('\n');
        row.push(Number(cell_8[0]));
        row.push(cell_8.slice(4).map((x) => x.trim()).filter(Boolean).join('\n'));

        let cell_9 = $(cells[9]).text().trim().split('\n');
        row.push(Number(cell_9[0]));
        row.push(cell_9.slice(4).map((x) => x.trim()).filter(Boolean).join('\n'));
        data.push(row);
    });
    return data;
}

// Обработчик кнопки excel
$(function () {
    $('#excel').click(function() {
        let tableData = getTable();
        let wb = XLSX.utils.book_new();
        let ws = XLSX.utils.aoa_to_sheet(tableData);
        XLSX.utils.book_append_sheet(wb, ws, "ports");
        XLSX.writeFile(wb, "report_switch_ports.xlsx");
    });
});

rezervSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    switch(data.type) {
        case 'start':
            addMessage(data.message, 'info');
            updateProgress(data.progress);
            break;

        case 'success':
            addMessage(data.message, 'success');
            updateProgress(data.progress);
            break;

        case 'warning':
            addMessage(data.message, 'warning');
            updateProgress(data.progress);
            break;

        case 'complete':
            addMessage(data.message, 'info');
            updateProgress(data.progress);
            if (data.action == 'show') {
                showTable(data.data);
            }
            $('.rez').find('span').removeClass('spinner-border spinner-border-sm');
            $('.rez').prop('disabled', false);
            break;

        case 'error':
            addMessage(data.message, 'error');
            $('.rez').find('span').removeClass('spinner-border spinner-border-sm');
            $('.rez').prop('disabled', false);
            break;

        default:
            addMessage(data.message, 'info');
    }
};

// Функции добавления сообщения
function addMessage(message, type) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    messageDiv.innerHTML = `
        <span class="text">${message}</span>
    `;
    document.getElementById('messages').appendChild(messageDiv);
    messageDiv.scrollIntoView({ behavior: 'smooth' });
}

function updateProgress(percent) {
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');

    if (progressBar) {
        progressBar.style.width = percent + '%';
        progressBar.setAttribute('aria-valuenow', percent);
    }

    if (progressText) {
        progressText.textContent = percent + '%';
    }
}

function showTable(response) {
    $("#table-rezerv").show();
    $("#rezerv").empty();
    let counter = 1
    for (csw in response) {
    $("#rezerv").append(`
    <tr>
        <th scope="row">${counter}</th>
        <td>${csw}</td>
        <td>${response[csw].rezerv_1g}</td>
        <td>${response[csw].rezerv_1g_planning}</td>
        <td>${response[csw].rezerv_dir2_4_4}</td>
        <td>${response[csw].no_description_1g}</td>
        <td>${response[csw].no_description_10g}</td>
        <td>
            <div>
                ${response[csw].other_rezerv_1g.length}
                <span class="dropdown-btn" onclick="toggleDropdown(this)">Показать</span>
                <div class="dropdown-content" style="display:none" id="other_rezerv_1g_${counter}">
                </div>
            </div>
        </td>
        <td>
            <div>
                ${response[csw].other_rezerv_10g.length}
                <span class="dropdown-btn" onclick="toggleDropdown(this)">Показать</span>
                <div class="dropdown-content" style="display:none" id="other_rezerv_10g_${counter}">
                </div>
            </div>
        </td>
        <td>
            <div>
                ${response[csw].with_desc_no_link_1g.length}
                <span class="dropdown-btn" onclick="toggleDropdown(this)">Показать</span>
                <div class="dropdown-content" style="display:none" id="with_desc_no_link_1g_${counter}">
                </div>
            </div>
        </td>
        <td>
            <div>
                ${response[csw].with_desc_no_link_10g.length}
                <span class="dropdown-btn" onclick="toggleDropdown(this)">Показать</span>
                <div class="dropdown-content" style="display:none" id="with_desc_no_link_10g_${counter}">
                </div>
            </div>
        </td>
    </tr>
    `);

    for (col of ["other_rezerv_1g", "other_rezerv_10g", "with_desc_no_link_1g", "with_desc_no_link_10g"]) {
        for (val of response[csw][col]) {
         $("#"+col+"_"+counter).append(`
         <div>${val}</div>
         `);
         }
    }
    counter += 1
    }
}
</script>

{% endblock %}